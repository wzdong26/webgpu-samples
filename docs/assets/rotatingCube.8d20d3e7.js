function G(r){let e=!1;return()=>{if(e)return;e=!0;const i=requestAnimationFrame(function(t){n(),e=!1,r(t)}),n=()=>cancelAnimationFrame(i);return n}}function R(r){let e=!1;const i=G(function(n){e||(r(n),i())});return i(),()=>{e=!0}}var T=`@binding(0) @group(0) var<uniform> mvpMatrix : mat4x4<f32>;\r
\r
struct VertexOutput {\r
    @builtin(position) Position : vec4<f32>,\r
    @location(0) fragUV : vec2<f32>,\r
    @location(1) fragPosition: vec4<f32>\r
};\r
\r
@vertex\r
fn main(\r
    @location(0) position : vec4<f32>,\r
    @location(1) uv : vec2<f32>\r
) -> VertexOutput {\r
    var output : VertexOutput;\r
    output.Position = mvpMatrix * position;\r
    output.fragUV = uv;\r
    output.fragPosition = 0.5 * (position + vec4<f32>(1.0, 1.0, 1.0, 1.0));\r
    return output;\r
}`,q=`@fragment\r
fn main(\r
    @location(0) fragUV: vec2<f32>,\r
    @location(1) fragPosition: vec4<f32>\r
) -> @location(0) vec4<f32> {\r
    return fragPosition;\r
}`;const V={vertex:new Float32Array([1,-1,1,1,1,-1,-1,1,0,1,-1,-1,-1,0,0,1,-1,-1,1,0,1,-1,1,1,1,-1,-1,-1,0,0,1,1,1,1,1,1,-1,1,0,1,1,-1,-1,0,0,1,1,-1,1,0,1,1,1,1,1,1,-1,-1,0,0,-1,1,1,1,1,1,1,1,0,1,1,1,-1,0,0,-1,1,-1,1,0,-1,1,1,1,1,1,1,-1,0,0,-1,-1,1,1,1,-1,1,1,0,1,-1,1,-1,0,0,-1,-1,-1,1,0,-1,-1,1,1,1,-1,1,-1,0,0,1,1,1,1,1,-1,1,1,0,1,-1,-1,1,0,0,-1,-1,1,0,0,1,-1,1,1,0,1,1,1,1,1,1,-1,-1,1,1,-1,-1,-1,0,1,-1,1,-1,0,0,1,1,-1,1,0,1,-1,-1,1,1,-1,1,-1,0,0]),vertexCount:36};var E=1e-6,A=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var r=0,e=arguments.length;e--;)r+=arguments[e]*arguments[e];return Math.sqrt(r)});function U(){var r=new A(16);return A!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function S(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function b(r,e,i){var n=e[0],t=e[1],a=e[2],s=e[3],c=e[4],f=e[5],p=e[6],v=e[7],l=e[8],h=e[9],x=e[10],m=e[11],M=e[12],w=e[13],P=e[14],z=e[15],o=i[0],d=i[1],y=i[2],g=i[3];return r[0]=o*n+d*c+y*l+g*M,r[1]=o*t+d*f+y*h+g*w,r[2]=o*a+d*p+y*x+g*P,r[3]=o*s+d*v+y*m+g*z,o=i[4],d=i[5],y=i[6],g=i[7],r[4]=o*n+d*c+y*l+g*M,r[5]=o*t+d*f+y*h+g*w,r[6]=o*a+d*p+y*x+g*P,r[7]=o*s+d*v+y*m+g*z,o=i[8],d=i[9],y=i[10],g=i[11],r[8]=o*n+d*c+y*l+g*M,r[9]=o*t+d*f+y*h+g*w,r[10]=o*a+d*p+y*x+g*P,r[11]=o*s+d*v+y*m+g*z,o=i[12],d=i[13],y=i[14],g=i[15],r[12]=o*n+d*c+y*l+g*M,r[13]=o*t+d*f+y*h+g*w,r[14]=o*a+d*p+y*x+g*P,r[15]=o*s+d*v+y*m+g*z,r}function C(r,e,i){var n=i[0],t=i[1],a=i[2],s,c,f,p,v,l,h,x,m,M,w,P;return e===r?(r[12]=e[0]*n+e[4]*t+e[8]*a+e[12],r[13]=e[1]*n+e[5]*t+e[9]*a+e[13],r[14]=e[2]*n+e[6]*t+e[10]*a+e[14],r[15]=e[3]*n+e[7]*t+e[11]*a+e[15]):(s=e[0],c=e[1],f=e[2],p=e[3],v=e[4],l=e[5],h=e[6],x=e[7],m=e[8],M=e[9],w=e[10],P=e[11],r[0]=s,r[1]=c,r[2]=f,r[3]=p,r[4]=v,r[5]=l,r[6]=h,r[7]=x,r[8]=m,r[9]=M,r[10]=w,r[11]=P,r[12]=s*n+v*t+m*a+e[12],r[13]=c*n+l*t+M*a+e[13],r[14]=f*n+h*t+w*a+e[14],r[15]=p*n+x*t+P*a+e[15]),r}function L(r,e,i){var n=i[0],t=i[1],a=i[2];return r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r[3]=e[3]*n,r[4]=e[4]*t,r[5]=e[5]*t,r[6]=e[6]*t,r[7]=e[7]*t,r[8]=e[8]*a,r[9]=e[9]*a,r[10]=e[10]*a,r[11]=e[11]*a,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function u(r,e,i){var n=Math.sin(i),t=Math.cos(i),a=e[4],s=e[5],c=e[6],f=e[7],p=e[8],v=e[9],l=e[10],h=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=a*t+p*n,r[5]=s*t+v*n,r[6]=c*t+l*n,r[7]=f*t+h*n,r[8]=p*t-a*n,r[9]=v*t-s*n,r[10]=l*t-c*n,r[11]=h*t-f*n,r}function N(r,e,i){var n=Math.sin(i),t=Math.cos(i),a=e[0],s=e[1],c=e[2],f=e[3],p=e[8],v=e[9],l=e[10],h=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=a*t-p*n,r[1]=s*t-v*n,r[2]=c*t-l*n,r[3]=f*t-h*n,r[8]=a*n+p*t,r[9]=s*n+v*t,r[10]=c*n+l*t,r[11]=f*n+h*t,r}function Y(r,e,i){var n=Math.sin(i),t=Math.cos(i),a=e[0],s=e[1],c=e[2],f=e[3],p=e[4],v=e[5],l=e[6],h=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=a*t+p*n,r[1]=s*t+v*n,r[2]=c*t+l*n,r[3]=f*t+h*n,r[4]=p*t-a*n,r[5]=v*t-s*n,r[6]=l*t-c*n,r[7]=h*t-f*n,r}function j(r,e,i,n,t){var a=1/Math.tan(e/2),s;return r[0]=a/i,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=a,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,t!=null&&t!==1/0?(s=1/(n-t),r[10]=(t+n)*s,r[14]=2*t*n*s):(r[10]=-1,r[14]=-2*n),r}var D=j;function I(r,e,i,n){var t,a,s,c,f,p,v,l,h,x,m=e[0],M=e[1],w=e[2],P=n[0],z=n[1],o=n[2],d=i[0],y=i[1],g=i[2];return Math.abs(m-d)<E&&Math.abs(M-y)<E&&Math.abs(w-g)<E?S(r):(v=m-d,l=M-y,h=w-g,x=1/Math.hypot(v,l,h),v*=x,l*=x,h*=x,t=z*h-o*l,a=o*v-P*h,s=P*l-z*v,x=Math.hypot(t,a,s),x?(x=1/x,t*=x,a*=x,s*=x):(t=0,a=0,s=0),c=l*s-h*a,f=h*t-v*s,p=v*a-l*t,x=Math.hypot(c,f,p),x?(x=1/x,c*=x,f*=x,p*=x):(c=0,f=0,p=0),r[0]=t,r[1]=c,r[2]=v,r[3]=0,r[4]=a,r[5]=f,r[6]=l,r[7]=0,r[8]=s,r[9]=p,r[10]=h,r[11]=0,r[12]=-(t*m+a*M+s*w),r[13]=-(c*m+f*M+p*w),r[14]=-(v*m+l*M+h*w),r[15]=1,r)}function W(){var r=new A(3);return A!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function B(r,e,i){var n=new A(3);return n[0]=r,n[1]=e,n[2]=i,n}(function(){var r=W();return function(e,i,n,t,a,s){var c,f;for(i||(i=3),n||(n=0),t?f=Math.min(t*i+n,e.length):f=e.length,c=n;c<f;c+=i)r[0]=e[c],r[1]=e[c+1],r[2]=e[c+2],a(r,r,s),e[c]=r[0],e[c+1]=r[1],e[c+2]=r[2];return e}})();function F(r,e,i,n){const t=_(e,i,n),a=X(r),s=U();return b(s,a,t),s}function _(r={x:0,y:0,z:0},e={x:0,y:0,z:0},i={x:1,y:1,z:1}){const n=U();return C(n,n,B(r.x,r.y,r.z)),u(n,n,e.x),N(n,n,e.y),Y(n,n,e.z),L(n,n,B(i.x,i.y,i.z)),n}const k=B(0,0,0),H=B(0,1,0);function X(r,e=60/180*Math.PI,i=.1,n=100,t={x:0,y:0,z:0}){const a=U(),s=B(t.x,t.y,t.z);C(a,a,s),I(a,s,k,H);const c=U();return D(c,e,r,i,n),b(c,c,a),c}async function K(r){return J(r)}function Z(r,e,i,n){const t={position:{x:2,y:0,z:-8},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},a={position:{x:-2,y:0,z:-8},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}};return function(c){c=c/1e3,t.rotation.x=Math.sin(c),t.rotation.y=Math.cos(c);const f=F(n,t.position,t.rotation,t.scale);r.queue.writeBuffer(e.buffer,0,f),a.rotation.x=Math.cos(c),a.rotation.y=Math.sin(c);const p=F(n,a.position,a.rotation,a.scale);r.queue.writeBuffer(i.buffer,0,p)}}async function J(r){var m,M;const{gpu:e}=navigator,i=await((m=e==null?void 0:e.requestAdapter)==null?void 0:m.call(e,{}));if(!i)throw Error("WebGPU not support! Adapter not found!");const n=(M=e.getPreferredCanvasFormat)==null?void 0:M.call(e);if(!n)throw Error("WebGPU not support! Adapter not found!");const t=await i.requestDevice(),a=r.getContext("webgpu"),{devicePixelRatio:s=1}=window,c={width:r.clientWidth*s,height:r.clientHeight*s};Object.assign(r,c),a.configure({device:t,format:n,alphaMode:"premultiplied"});const f=t.createRenderPipeline({vertex:{module:t.createShaderModule({code:T}),entryPoint:"main",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*4,format:"float32x2"}],arrayStride:4*5,stepMode:"vertex"}]},fragment:{module:t.createShaderModule({code:q}),entryPoint:"main",targets:[{format:n}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},layout:"auto"}),p=t.createBuffer({size:V.vertex.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});t.queue.writeBuffer(p,0,V.vertex,0,V.vertex.length);const v=O(t,f),l=O(t,f),h=t.createTexture({size:c,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}).createView(),x=Z(t,v,l,c.width/c.height);return R(w=>{x(w);const P=t.createCommandEncoder(),z=a.getCurrentTexture().createView(),o=P.beginRenderPass({colorAttachments:[{view:z,clearValue:{r:0,g:.5,b:1,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:h,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});o.setPipeline(f),o.setVertexBuffer(0,p),o.setBindGroup(0,v.group),o.draw(V.vertexCount),o.setBindGroup(0,l.group),o.draw(V.vertexCount),o.end(),t.queue.submit([P.finish()])})}function O(r,e){const i=r.createBuffer({size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),n=r.createBindGroup({layout:e.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:i}}]});return{buffer:i,group:n}}export{K as render};
